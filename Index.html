import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, onSnapshot } from 'firebase/firestore';

const App = () => {
  // Global variables provided by the Canvas environment
  // We check if they exist before using them to prevent errors.
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // State to manage app data and UI
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [profile, setProfile] = useState(null);
  const [isNewUser, setIsNewUser] = useState(false);
  const [showProfileForm, setShowProfileForm] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    specialty: '',
    territory: '',
    linkedin: '',
    role: '',
    companyName: '',
    productCategory: '',
    description: ''
  });
  const [matchResults, setMatchResults] = useState([]);
  const [liveReps, setLiveReps] = useState([]);
  const [liveDevices, setLiveDevices] = useState([]);
  const [matchmakingLoading, setMatchmakingLoading] = useState(false);

  // 1. Initialize Firebase & Auth on component mount
  useEffect(() => {
    const initFirebase = async () => {
      try {
        if (!firebaseConfig.projectId) {
          throw new Error("Firebase configuration is missing or invalid. Please provide the correct firebaseConfig object.");
        }
        
        const app = initializeApp(firebaseConfig);
        const authInstance = getAuth(app);
        const dbInstance = getFirestore(app);

        setAuth(authInstance);
        setDb(dbInstance);

        const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
          if (currentUser) {
            setUser(currentUser);
            await checkUserProfile(dbInstance, currentUser.uid);
          } else {
            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          }
          setLoading(false);
        });

        // Cleanup the listener on unmount
        return () => unsubscribe();
      } catch (e) {
        console.error('Firebase initialization error:', e);
        setError(e.message);
        setLoading(false);
      }
    };

    if (Object.keys(firebaseConfig).length > 0) {
      initFirebase();
    } else {
      setError("Firebase configuration is missing.");
      setLoading(false);
    }
  }, [firebaseConfig, initialAuthToken]);

  // 2. Real-time data fetching from Firestore
  useEffect(() => {
    if (!db) return;

    // Reps collection listener
    const repsColRef = collection(db, 'reps');
    const unsubscribeReps = onSnapshot(repsColRef, (snapshot) => {
      const repsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setLiveReps(repsData);
    }, (e) => console.error("Error fetching reps:", e));

    // Devices collection listener
    const devicesColRef = collection(db, 'devices');
    const unsubscribeDevices = onSnapshot(devicesColRef, (snapshot) => {
      const devicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setLiveDevices(devicesData);
    }, (e) => console.error("Error fetching devices:", e));

    return () => {
      unsubscribeReps();
      unsubscribeDevices();
    };
  }, [db]);


  // 3. Check for User Profile in Firestore
  const checkUserProfile = async (dbInstance, uid) => {
    // The path to a user's profile is /artifacts/{appId}/users/{userId}/profile
    const profileRef = doc(dbInstance, 'artifacts', appId, 'users', uid, 'profile');
    try {
      const profileSnap = await getDoc(profileRef);
      if (profileSnap.exists()) {
        setProfile(profileSnap.data());
        setIsNewUser(false);
      } else {
        setIsNewUser(true);
        setShowProfileForm(true);
      }
    } catch (e) {
      console.error("Error checking user profile:", e);
      setError(e.message);
    }
  };

  // 4. Handle Form Changes
  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prevData => ({ ...prevData, [name]: value }));
  };

  const handleRoleChange = (e) => {
    setFormData(prevData => ({ ...prevData, role: e.target.value }));
  };
  
  // 5. Handle Profile Submission to Firestore
  const handleProfileSubmit = async (e) => {
    e.preventDefault();
    if (!user || !db) return;

    try {
      const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
      await setDoc(userProfileRef, {
        ...formData,
        createdAt: new Date().toISOString(),
        userId: user.uid,
      });

      // Also save to the relevant public collection for matchmaking
      const collectionRef = formData.role === 'rep' ? collection(db, 'reps') : collection(db, 'devices');
      await setDoc(doc(collectionRef, user.uid), {
        name: formData.name,
        specialty: formData.specialty,
        territory: formData.territory,
        bio: formData.role === 'rep' ? 'Rep bio here...' : formData.description, // Use bio for display
        userId: user.uid
      });

      setProfile(formData);
      setShowProfileForm(false);
      setIsNewUser(false);
    } catch (e) {
      console.error("Error submitting profile:", e);
      setError(e.message);
    }
  };

  // 6. Handle Matchmaking Form Submission
  const handleMatchmakingSubmit = (e) => {
    e.preventDefault();
    setMatchmakingLoading(true);

    const role = e.target['match-role'].value;
    const specialty = e.target['match-specialty'].value.toLowerCase();
    const territory = e.target['match-territory'].value;

    let matches = [];
    if (role === 'rep') {
      // Find innovators for the rep from live data
      matches = liveInnovators.filter(innovator => 
        innovator.specialty.toLowerCase().includes(specialty) && innovator.territory === territory
      );
    } else {
      // Find reps for the innovator from live data
      matches = liveReps.filter(rep => 
        rep.specialty.toLowerCase().includes(specialty) && rep.territory === territory
      );
    }
    
    setTimeout(() => {
        setMatchResults(matches);
        setMatchmakingLoading(false);
    }, 1000); // Simulate a network delay
  };

  // UI for the profile creation form
  const renderProfileForm = () => {
    if (!showProfileForm) return null;

    return (
      <div className="mt-12 p-8 bg-white rounded-xl shadow-lg">
        <h2 className="text-2xl font-bold text-[#343A40] mb-6 text-center">Complete Your Profile</h2>
        <form onSubmit={handleProfileSubmit} className="max-w-xl mx-auto">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">Name</label>
              <input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-3 border border-gray-300 rounded-lg"/>
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">Email</label>
              <input type="email" name="email" value={formData.email} onChange={handleChange} required className="w-full p-3 border border-gray-300 rounded-lg"/>
            </div>
          </div>
          <div className="mt-6">
            <label className="block text-sm font-bold text-gray-700 mb-2">My Role</label>
            <select name="role" value={formData.role} onChange={handleRoleChange} required className="w-full p-3 border border-gray-300 rounded-lg">
              <option value="">Select Role</option>
              <option value="rep">Sales Representative</option>
              <option value="devices">Medical Devices</option>
            </select>
          </div>
          {formData.role === 'rep' && (
            <div className="mt-6">
              <label className="block text-sm font-bold text-gray-700 mb-2">Medical Specialties</label>
              <input type="text" name="specialty" value={formData.specialty} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Orthopedics, Cardiology"/>
              <label className="block text-sm font-bold text-gray-700 mt-4 mb-2">Current Territory</label>
              <select name="territory" value={formData.territory} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg">
                <option value="">Select Territory</option>
                <option value="west">West (US)</option>
                <option value="midwest">Midwest (US)</option>
                <option value="southeast">Southeast (US)</option>
              </select>
            </div>
          )}
          {formData.role === 'devices' && (
            <div className="mt-6">
              <label className="block text-sm font-bold text-gray-700 mb-2">Company Name</label>
              <input type="text" name="companyName" value={formData.companyName} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" placeholder="Innovative MedTech Inc."/>
              <label className="block text-sm font-bold text-gray-700 mt-4 mb-2">Product Category</label>
              <input type="text" name="productCategory" value={formData.productCategory} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., Surgical Robotics"/>
              <label className="block text-sm font-bold text-gray-700 mt-4 mb-2">Target Territories</label>
              <select name="territory" value={formData.territory} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg">
                <option value="">Select Territories</option>
                <option value="west">West (US)</option>
                <option value="midwest">Midwest (US)</option>
                <option value="southeast">Southeast (US)</option>
              </select>
            </div>
          )}
          <div className="mt-6">
            <label className="block text-sm font-bold text-gray-700 mb-2">LinkedIn Profile URL</label>
            <input type="url" name="linkedin" value={formData.linkedin} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" placeholder="https://linkedin.com/in/yourprofile"/>
          </div>
          <div className="mt-8 text-center">
            <button type="submit" className="bg-[#28A745] text-white font-bold py-3 px-8 rounded-lg hover:bg-[#218838] transition-colors duration-300 shadow-md">
              Save Profile
            </button>
          </div>
        </form>
      </div>
    );
  };

  // UI for viewing a saved profile
  const renderProfileView = () => {
    if (!profile) return null;

    return (
      <div className="mt-12 p-8 bg-white rounded-xl shadow-lg">
        <h2 className="text-2xl font-bold text-[#343A40] mb-6 text-center">Your Profile</h2>
        <div className="max-w-xl mx-auto space-y-4 text-left">
          <p><strong>Name:</strong> {profile.name}</p>
          <p><strong>Email:</strong> {profile.email}</p>
          <p><strong>Role:</strong> {profile.role === 'rep' ? 'Sales Representative' : 'Medical Device'}</p>
          {profile.role === 'rep' && (
            <>
              <p><strong>Specialty:</strong> {profile.specialty}</p>
              <p><strong>Territory:</strong> {profile.territory}</p>
            </>
          )}
          {profile.role === 'devices' && (
            <>
              <p><strong>Company Name:</strong> {profile.companyName}</p>
              <p><strong>Product Category:</strong> {profile.productCategory}</p>
              <p><strong>Target Territories:</strong> {profile.territory}</p>
            </>
          )}
          <p><strong>LinkedIn:</strong> <a href={profile.linkedin} target="_blank" rel="noopener noreferrer" className="text-[#28A745] hover:underline">{profile.linkedin}</a></p>
          <div className="text-center mt-6">
            <button onClick={() => setShowProfileForm(true)} className="bg-[#343A40] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#23272B] transition-colors duration-300">
              Edit Profile
            </button>
          </div>
        </div>
      </div>
    );
  };
  
  // SVG logo component (unchanged)
  const MedConneXLogo = ({ color, accentColor }) => (
    <svg width="320" height="100" viewBox="0 0 320 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gradient_dynamic_x" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color={color} />
            <stop offset="100%" stop-color={accentColor} />
          </linearGradient>
        </defs>
        <text x="10" y="60" fontFamily="Inter, sans-serif" fontWeight="700" fontSize="38" fill={color}>MedConne</text>
        <g transform="translate(215, 10) scale(1.1)">
          <path d="M0 0 L20 35 L0 70 H10 L30 35 L10 0 Z" fill={color} opacity="0.9"/>
          <path d="M30 0 L10 35 L30 70 H20 L0 35 L20 0 Z" fill="url(#gradient_dynamic_x)" opacity="0.9"/>
          <circle cx="15" cy="35" r="3" fill={accentColor}/>
        </g>
    </svg>
  );
  
  // UI for the matchmaking form
  const renderMatchmakingForm = () => (
    <form id="match-form" className="mt-6" onSubmit={handleMatchmakingSubmit}>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label htmlFor="match-role" className="block text-sm font-bold text-gray-700 mb-2 text-left">Find a Match for</label>
                <select id="match-role" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#28A745] focus:border-transparent transition" 
                  value={profile?.role === 'rep' ? 'devices' : 'rep'}
                  disabled
                >
                    <option value="rep">Sales Representative</option>
                    <option value="devices">Medical Devices</option>
                </select>
            </div>
            <div>
                <label htmlFor="match-specialty" className="block text-sm font-bold text-gray-700 mb-2 text-left">Specialty / Product</label>
                <input type="text" id="match-specialty" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#28A745] focus:border-transparent transition" 
                  placeholder="e.g., Orthopedics, Cardiology, Robotics" 
                  value={profile?.specialty || profile?.productCategory || ''}
                  readOnly
                  required
                />
            </div>
        </div>
        <div className="mt-6">
            <label htmlFor="match-territory" className="block text-sm font-bold text-gray-700 mb-2 text-left">Territory</label>
            <select id="match-territory" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#28A745] focus:border-transparent transition" 
              value={profile?.territory || ''}
              readOnly
              required
            >
                <option value="">Select a territory</option>
                <option value="west">West (US)</option>
                <option value="midwest">Midwest (US)</option>
                <option value="southeast">Southeast (US)</option>
                <option value="northeast">Northeast (US)</option>
            </select>
        </div>
        <div className="mt-8 text-center">
            <button type="submit" className="bg-[#28A745] text-white font-bold py-3 px-8 rounded-lg hover:bg-[#218838] transition-colors duration-300 shadow-md">
                {matchmakingLoading ? (
                    <div className="flex items-center justify-center space-x-2">
                        <div className="w-4 h-4 rounded-full animate-spin border-2 border-solid border-white border-t-transparent"></div>
                        <span>Searching...</span>
                    </div>
                ) : "Find My Match"}
            </button>
        </div>
    </form>
  );

  // Loading and Error UI
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-6 text-gray-800">
        <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full text-center">
          <p className="text-xl">Loading...</p>
        </div>
      </div>
    );
  }
  if (error) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center p-6 text-gray-800">
        <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg w-full text-center">
          <p className="text-xl text-red-500">Error: {error}</p>
        </div>
      </div>
    );
  }

  // Main UI
  return (
    <div className="bg-gray-100 text-gray-800 font-sans leading-normal">
      {/* Header Section */}
      <header className="bg-gradient-to-r from-[#343A40] to-[#28A745] text-white p-6 md:p-10 text-center shadow-lg">
        <div className="flex justify-center items-center w-full mb-4">
          <MedConneXLogo color="#FFFFFF" accentColor="#28A745" />
        </div>
        <p className="text-lg font-light opacity-95">Connecting medical device sales contractors with growing devices & emerging companies</p>
      </header>

      {/* Navigation Bar */}
      <nav className="bg-[#343A40] text-white p-4 sticky top-0 z-50 shadow-md">
        <div className="container mx-auto flex justify-center flex-wrap gap-x-6 gap-y-2">
          <a href="#profile" className="font-semibold hover:text-[#28A745] transition-colors duration-300">Profile</a>
          <a href="#matchmaking" className="font-semibold hover:text-[#28A745] transition-colors duration-300">Matchmaking</a>
        </div>
      </nav>

      <main className="container mx-auto px-4 py-12">
        {/* User Profile Section */}
        <section id="profile" className="p-8 bg-white rounded-xl shadow-lg text-center">
            <h2 className="text-3xl font-bold text-[#343A40] mb-6">Your MedConneX Profile</h2>
            <p className="max-w-3xl mx-auto leading-relaxed text-gray-700 mb-8">
                Your profile is the key to getting matched with the perfect partner.
            </p>
            {isNewUser && (
                <p className="text-lg text-gray-600">Please complete your profile to start using MedConneX.</p>
            )}
            {showProfileForm && renderProfileForm()}
            {profile && !showProfileForm && renderProfileView()}
            {user && profile && (
              <p className="mt-8 text-sm text-gray-500">Your unique User ID: <code className="font-mono">{user.uid}</code></p>
            )}
        </section>

        {/* AI Matchmaking Demo Section */}
        <section id="matchmaking" className="p-8 bg-white rounded-xl shadow-lg text-center">
          <h2 className="text-3xl font-bold text-[#343A40] mb-6 text-center">AI Matchmaking</h2>
          <p className="max-w-3xl mx-auto leading-relaxed mb-12">
            See how MedConneX intelligently connects you with the perfect partner. Select your criteria below to find your ideal match in our network.
          </p>
          <div className="max-w-xl mx-auto">
            {profile ? (
              renderMatchmakingForm()
            ) : (
              <p className="text-lg text-gray-600">Please complete your profile to use the matchmaking service.</p>
            )}
          </div>
          <div id="match-results" className="mt-12 text-left space-y-4">
              {matchmakingLoading ? (
                <div className="p-6 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center">
                  <div className="w-4 h-4 rounded-full animate-spin border-2 border-solid border-[#28A745] border-t-transparent"></div>
                  <p className="ml-4 text-gray-600">Searching for your match...</p>
                </div>
              ) : matchResults.length > 0 ? (
                <>
                  <p className="text-xl font-semibold text-[#343A40]">Matches Found:</p>
                  {matchResults.map((match, index) => (
                    <div key={index} className="p-6 bg-gray-50 rounded-lg border border-gray-200">
                      <p className="text-lg font-bold">{match.name}</p>
                      <p className="text-sm text-gray-600">Specialty: {match.specialty}</p>
                      <p className="text-sm text-gray-600">Territory: {match.territory}</p>
                      <p className="text-sm text-gray-600 mt-2">{match.bio}</p>
                    </div>
                  ))}
                </>
              ) : (
                <div className="p-6 bg-gray-50 rounded-lg border border-gray-200">
                  <p className="text-center text-gray-500">No matches found. Try a different search.</p>
                </div>
              )}
          </div>
        </section>
      </main>
      
      {/* Footer */}
      <footer className="bg-[#343A40] text-white text-center p-6 mt-16">
        <p>&copy; 2025 MedConneX. All rights reserved.</p>
        <div className="flex justify-center gap-x-6 mt-4">
            <a href="#privacy-policy" className="text-white hover:text-[#28A745] transition-colors duration-300">Privacy Policy</a>
            <span className="text-gray-500">|</span>
            <a href="#terms-conditions" className="text-white hover:text-[#28A745] transition-colors duration-300">Terms & Conditions</a>
        </div>
      </footer>
    </div>
  );
};

export default App;
